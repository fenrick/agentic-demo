<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Agentic Demo</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css" integrity="sha512-9NqN6o/GjK4YHLGMeqK5dCV5mNMofuFDgkxku7+qw1KoH2vvAo7+C+NLp0oH8sb6KkFvQ/0D5EWliiW0wCTI9g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
body { margin: 2em; }
textarea { width: 100%; box-sizing: border-box; resize: none; }
#output { border: 1px solid #ccc; padding: 0.5em; min-height: 6em; margin-top: 1em; overflow-wrap: anywhere; }
</style>
</head>
<body>
<h1>Agentic Demo</h1>
<textarea id="text" rows="4" placeholder="Enter topic"></textarea>
<select id="mode">
  <option value="basic">basic</option>
  <option value="overlay">overlay</option>
</select>
<button id="run">Run</button>
<button id="cancel">Cancel</button>
<div id="output"></div>
<button id="save-md">Download Markdown</button>
<button id="save-docx">Download DOCX</button>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" integrity="sha384-eDzOAsrZsXwOrN8v7DqM8o30ezwTG5Ae8tm0wYuo+8KBw9yLYkhIbZP+pt2K1SVP" crossorigin="anonymous"></script>
<script>
(function() {
  let finalText = "";
  const out = document.getElementById('output');
  let ws = null;

  function resize(e) {
    const el = e.target;
    el.style.height = 'auto';
    el.style.height = el.scrollHeight + 'px';
  }
  const textEl = document.getElementById('text');
  textEl.addEventListener('input', resize);
  window.addEventListener('load', () => resize({target: textEl}));

  document.getElementById('run').onclick = function() {
    out.innerHTML = "";
    finalText = "";
    const text = textEl.value;
    const mode = document.getElementById('mode').value;
    ws = new WebSocket(`ws://${location.host}/stream?input=${encodeURIComponent(text)}&mode=${mode}`);
    ws.onmessage = ev => {
      finalText += ev.data + "\n";
      out.innerHTML = marked.parse(finalText);
    };
    ws.onerror = () => { out.textContent = 'WebSocket error'; };
    ws.onclose = ev => {
      if (!ev.wasClean) {
        out.textContent += '\n[connection closed]';
      }
      window.demoOutput = finalText;
    };
  };
  document.getElementById('save-md').onclick = function() {
    const blob = new Blob([window.demoOutput || ""], {type: 'text/markdown'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = 'output.md'; a.click();
  };
  document.getElementById('cancel').onclick = function() {
    if (ws) { ws.close(); }
  };
  document.getElementById('save-docx').onclick = async function() {
    try {
      const r = await fetch('/export/docx', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text: window.demoOutput || ''})});
      const b = await r.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(b); a.download = 'output.docx'; a.click();
    } catch (err) {
      alert('Failed to download DOCX');
    }
  };
})();
</script>
</body>
</html>
