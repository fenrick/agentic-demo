<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Agentic Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-3xl mx-auto space-y-4">
    <form id="topic-form" class="flex space-x-2">
      <input id="topic" name="topic" class="flex-grow p-2 border" placeholder="Enter lecture topic" />
      <button id="start" class="bg-blue-500 text-white px-4" type="submit">Start</button>
      <button id="cancel" class="bg-red-500 text-white px-4 hidden" type="button">Cancel</button>
    </form>
    <div id="logs" class="bg-white p-2 h-40 overflow-y-auto border"></div>
    <div id="output" class="bg-white p-2 h-60 overflow-y-auto border whitespace-pre-wrap"></div>
    <div class="space-x-2">
      <button id="dl-md" class="bg-green-500 text-white px-3 py-1 hidden">Markdown</button>
      <button id="dl-docx" class="bg-green-500 text-white px-3 py-1 hidden">DOCX</button>
      <button id="dl-pdf" class="bg-green-500 text-white px-3 py-1 hidden">PDF</button>
    </div>
  </div>
  <script>
  const form = document.getElementById('topic-form');
  const topicInput = document.getElementById('topic');
  const cancelBtn = document.getElementById('cancel');
  const logsDiv = document.getElementById('logs');
  const outputDiv = document.getElementById('output');
  const dlMd = document.getElementById('dl-md');
  const dlDocx = document.getElementById('dl-docx');
  const dlPdf = document.getElementById('dl-pdf');
  let evtSource;
  let runId;

  function setRunning(running) {
    topicInput.disabled = running;
    cancelBtn.classList.toggle('hidden', !running);
    dlMd.classList.toggle('hidden', running);
    dlDocx.classList.toggle('hidden', running);
    dlPdf.classList.toggle('hidden', running);
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const resp = await fetch('/runs', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({topic: topicInput.value})});
    const data = await resp.json();
    runId = data.run_id;
    setRunning(true);
    logsDiv.textContent = '';
    outputDiv.textContent = '';
    evtSource = new EventSource(`/runs/${runId}/stream`);
    evtSource.addEventListener('log', (ev) => {
      logsDiv.textContent += ev.data + '\n';
      logsDiv.scrollTop = logsDiv.scrollHeight;
    });
    evtSource.addEventListener('token', (ev) => {
      outputDiv.textContent += ev.data + ' ';
      outputDiv.scrollTop = outputDiv.scrollHeight;
    });
    evtSource.addEventListener('end', () => {
      evtSource.close();
      setRunning(false);
      dlMd.onclick = () => window.location = `/runs/${runId}/download/md`;
      dlDocx.onclick = () => window.location = `/runs/${runId}/download/docx`;
      dlPdf.onclick = () => window.location = `/runs/${runId}/download/pdf`;
    });
  });

  cancelBtn.addEventListener('click', () => {
    if (evtSource) {
      evtSource.close();
      setRunning(false);
    }
  });
  </script>
</body>
</html>
